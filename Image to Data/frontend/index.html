<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image(s) to Data Converter</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>Image(s) to Data Converter</h1>
            <p class="author">by Akmal Shldn</p>
            <div class="description">
                <p>Transform your image tables into structured data using OpenAI's GPT-4o model.</p>
            </div>
        </header>

        <main>
            <form id="uploadForm" class="upload-form">
                <div class="section">
                    <div class="section-header">
                        <div class="step-number">1</div>
                        <h2>Upload Images</h2>
                    </div>
                    <div class="section-content">
                        <div class="upload-area" id="dropZone">
                            <input type="file" id="imageFile" name="imageFile" accept="image/*" multiple>
                            <div class="upload-text">
                                <p>Drag and drop image files here</p>
                                <p>or</p>
                                <p>Click to select files</p>
                                <p class="upload-hint">Supported formats: JPG, PNG, GIF</p>
                            </div>
                        </div>
                        <div id="fileList" class="file-list"></div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <div class="step-number">2</div>
                        <h2>Define Table Context</h2>
                    </div>
                    <div class="section-content">
             <label for="imageDescription">Image Context/Description:</label>
             <input type="text" id="imageDescription" name="imageDescription" placeholder="e.g., Concordance KBKI 2015 to KBLI 2020">

                        <div class="columns-section">
                            <label>Number of Columns:</label>
                            <input type="number" id="columnCount" name="columnCount" min="1" required>
                            
                            <div id="columnDetails" class="column-details">
                                <!-- Column details will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <div class="step-number">3</div>
                        <h2>Extract Tables</h2>
                    </div>
                    <div class="section-content">
                        <button type="submit" id="extractButton">Extract Tables</button>
                        <div id="progressContainer" class="progress-container" style="display: none;">
                            <div class="progress-bar">
                                <div id="progressBar" class="progress"></div>
                            </div>
                            <p id="progressText">Processing: 0/0 files (0%)</p>
                        </div>
                 </div>
        </div>

                <div id="resultsSection" class="section" style="display: none;">
                    <div class="section-header">
                        <div class="step-number">4</div>
                        <h2>Results</h2>
                        <button id="toggleAllResults" class="toggle-all-button">Collapse All</button>
                    </div>
                    <div class="section-content">
                        <div id="resultsList" class="results-list"></div>
                        <div class="download-options">
                            <div class="download-group">
                                <div class="download-group-label">Excel Format</div>
                                <button id="downloadExcelSeparate" class="download-button">Download as Separate Sheets</button>
                                <button id="downloadExcelCombined" class="download-button">Download as Single Sheet</button>
                            </div>
                            <div class="download-group">
                                <div class="download-group-label">CSV Format</div>
                                <button id="downloadCSV" class="download-button">Download as Separate Files</button>
                                <button id="downloadCSVCombined" class="download-button">Download as Single File</button>
                            </div>
                        </div>
                    </div>
         </div>
    </form>
        </main>

        <footer>
            <p>© 2025 Image to Data Converter. All rights reserved.</p>
            <div class="social-links">
                <a href="https://github.com/akmaalsh" target="_blank" rel="noopener noreferrer">Akmal's GitHub</a>
                <span class="separator">•</span>
                <a href="https://www.linkedin.com/in/akmalshalahuddin/" target="_blank" rel="noopener noreferrer">Akmal's LinkedIn</a>
        </div>
        </footer>
    </div>

    <script>
        let ws = null;
        let currentJobId = null;
        const API_BASE_URL = 'http://localhost:3000';

        // File list management
        const fileInput = document.getElementById('imageFile');
        const fileList = document.getElementById('fileList');
        const dropZone = document.getElementById('dropZone');
        
        // Drag and drop handling
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary-color)';
            dropZone.style.background = 'var(--background-color)';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border-color)';
            dropZone.style.background = 'var(--background-secondary)';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border-color)';
            dropZone.style.background = 'var(--background-secondary)';
            
            const files = e.dataTransfer.files;
            fileInput.files = files;
            updateFileList(files);
        });
        
        fileInput.addEventListener('change', () => {
            updateFileList(fileInput.files);
        });

        function updateFileList(files) {
            fileList.innerHTML = '';
            Array.from(files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-status">Pending</span>
                `;
                fileList.appendChild(fileItem);
            });
        }

        // Column management
        const columnCount = document.getElementById('columnCount');
        const columnDetails = document.getElementById('columnDetails');

        columnCount.addEventListener('change', () => {
            const count = parseInt(columnCount.value);
            if (isNaN(count) || count < 1) return;

            columnDetails.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'column-input';
                columnDiv.innerHTML = `
                    <label>Column ${i + 1}:</label>
                    <input type="text" name="columnNames" placeholder="Column name" required>
                    <input type="text" name="columnExamples" placeholder="Example content">
                `;
                columnDetails.appendChild(columnDiv);
            }
        });

        // WebSocket connection management
        function connectWebSocket(port) {
            ws = new WebSocket(`ws://localhost:${port}`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateProgress(data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket connection closed');
            };
        }

        // Progress tracking
        function updateProgress(data) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const resultsList = document.getElementById('resultsList');

            progressContainer.style.display = 'block';
            progressBar.style.width = `${data.progress}%`;
            progressText.textContent = `Processing: ${data.processedCount}/${data.totalFiles} files (${data.progress}%)`;

            // Update file statuses
            if (data.latestResults) {
                data.latestResults.forEach(result => {
                    const fileItems = document.querySelectorAll('.file-item');
                    const fileItem = Array.from(fileItems).find(item => 
                        item.querySelector('.file-name').textContent === result.filename
                    );
                    
                    if (fileItem) {
                        const statusSpan = fileItem.querySelector('.file-status');
                        statusSpan.textContent = result.success ? 'Completed' : 'Failed';
                        statusSpan.className = `file-status ${result.success ? 'success' : 'error'}`;
                    }
                });
            }

            // Handle completion
            if (data.status === 'complete') {
                document.getElementById('resultsSection').style.display = 'block';
                displayResults(data.finalResults);
            }
        }

        // Results display
        function displayResults(results) {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';

            results.results.forEach((result, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${result.success ? 'success' : 'error'}`;
                
                if (result.success) {
                    resultItem.innerHTML = `
                        <h3 onclick="toggleResult(this)">${result.filename}</h3>
                        <div class="content">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>${result.data.headers.map(h => `<th>${h}</th>`).join('')}</tr>
                                    </thead>
                                    <tbody>
                                        ${result.data.rows.map(row => 
                                            `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`
                                        ).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    resultItem.innerHTML = `
                        <h3 onclick="toggleResult(this)">${result.filename}</h3>
                        <div class="content">
                            <p class="error-message">Error: ${result.error}</p>
                        </div>
                    `;
                }
                
                resultsList.appendChild(resultItem);
            });
        }

        // Toggle result collapse/expand
        function toggleResult(header) {
            const resultItem = header.parentElement;
            resultItem.classList.toggle('collapsed');
        }

        // Toggle all results
        function toggleAllResults() {
            const button = document.getElementById('toggleAllResults');
            const resultItems = document.querySelectorAll('.result-item');
            const isCollapsing = button.textContent === 'Collapse All';

            resultItems.forEach(item => {
                if (isCollapsing) {
                    item.classList.add('collapsed');
                } else {
                    item.classList.remove('collapsed');
                }
            });

            button.textContent = isCollapsing ? 'Expand All' : 'Collapse All';
        }

        // Add click event listener for toggle all button
        document.getElementById('toggleAllResults').addEventListener('click', toggleAllResults);

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select at least one file');
                return;
            }

            // Add files
            Array.from(files).forEach(file => {
                formData.append('imageFiles', file);
            });

            // Add other form data
            formData.append('imageDescription', document.getElementById('imageDescription').value);
            formData.append('columnCount', columnCount.value);
            
            // Add column details
            const columnNames = document.getElementsByName('columnNames');
            const columnExamples = document.getElementsByName('columnExamples');
            
            Array.from(columnNames).forEach(input => {
                formData.append('columnNames', input.value);
            });
            
            Array.from(columnExamples).forEach(input => {
                formData.append('columnExamples', input.value);
            });

            try {
                // Show progress container
                document.getElementById('progressContainer').style.display = 'block';
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressText').textContent = 'Starting processing...';

                // Submit the form
                const response = await fetch(`${API_BASE_URL}/api/extract-tables-batch`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    currentJobId = data.jobId;
                    connectWebSocket(data.wsPort);
                } else {
                    throw new Error(data.error);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred: ' + error.message);
            }
        });

        // Download handlers
        document.getElementById('downloadExcelSeparate').addEventListener('click', () => {
            const results = document.querySelectorAll('.result-item.success');
            if (results.length === 0) {
                alert('No successful results to download');
                return;
            }

            // Create workbook with separate sheets
            const wb = XLSX.utils.book_new();
            
            results.forEach((result, index) => {
                const table = result.querySelector('table');
                if (!table) return;

                // Convert table to worksheet
                const ws = XLSX.utils.table_to_sheet(table);
                
                // Add worksheet to workbook
                const filename = result.querySelector('h3').textContent;
                XLSX.utils.book_append_sheet(wb, ws, filename.substring(0, 31)); // Excel sheet name limit
            });

            // Save workbook
            XLSX.writeFile(wb, 'extracted_tables_separate.xlsx');
        });

        document.getElementById('downloadExcelCombined').addEventListener('click', () => {
            const results = document.querySelectorAll('.result-item.success');
            if (results.length === 0) {
                alert('No successful results to download');
                return;
            }

            // Create workbook with single sheet
            const wb = XLSX.utils.book_new();
            let allRows = [];
            let headers = [];

            // Collect all data
            results.forEach((result, index) => {
                const table = result.querySelector('table');
                if (!table) return;

                const ws = XLSX.utils.table_to_sheet(table);
                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });

                if (index === 0) {
                    headers = data[0];
                    allRows.push(data[0]); // Add headers only once
                }

                // Add filename column to each row
                const filename = result.querySelector('h3').textContent;
                data.slice(1).forEach(row => {
                    allRows.push([filename, ...row]);
                });
            });

            // Create worksheet with combined data
            const ws = XLSX.utils.aoa_to_sheet([
                ['Filename', ...headers],
                ...allRows.slice(1)
            ]);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Combined Data');

            // Save workbook
            XLSX.writeFile(wb, 'extracted_tables_combined.xlsx');
        });

        document.getElementById('downloadCSV').addEventListener('click', () => {
            const results = document.querySelectorAll('.result-item.success');
            if (results.length === 0) {
                alert('No successful results to download');
                return;
            }

            // Create zip containing all CSVs
            const zip = new JSZip();
            
            results.forEach((result, index) => {
                const table = result.querySelector('table');
                if (!table) return;

                // Convert table to CSV
                const ws = XLSX.utils.table_to_sheet(table);
                const csv = XLSX.utils.sheet_to_csv(ws);
                
                // Add to zip
                const filename = result.querySelector('h3').textContent;
                zip.file(`${filename}.csv`, csv);
            });

            // Generate and download zip
            zip.generateAsync({type: "blob"}).then(function(content) {
                const url = window.URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'extracted_tables_separate.zip';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            });
        });

        document.getElementById('downloadCSVCombined').addEventListener('click', () => {
            const results = document.querySelectorAll('.result-item.success');
            if (results.length === 0) {
                alert('No successful results to download');
                return;
            }

            let allRows = [];
            let headers = [];

            // Collect all data
            results.forEach((result, index) => {
                const table = result.querySelector('table');
                if (!table) return;

                const ws = XLSX.utils.table_to_sheet(table);
                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });

                if (index === 0) {
                    headers = data[0];
                    allRows.push(['Filename', ...headers].join(',')); // Add headers with filename column
                }

                // Add filename to each row
                const filename = result.querySelector('h3').textContent;
                data.slice(1).forEach(row => {
                    allRows.push([filename, ...row].join(','));
                });
            });

            // Create and download CSV file
            const csv = allRows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extracted_tables_combined.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>